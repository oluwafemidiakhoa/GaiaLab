<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GaiaLab Insight Board</title>
    <style>
      :root {
        color: #050816;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      html,
      body {
        width: 100%;
        min-height: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #050816;
      }

      main {
        width: 100%;
        max-width: 920px;
        min-height: 260px;
        margin: 0 auto;
        padding: 16px;
        box-sizing: border-box;
        background: radial-gradient(circle at top left, #111827, #020617 52%);
        border-radius: 18px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
        color: #e5e7eb;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }

      .title {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .title h2 {
        margin: 0;
        font-size: 1.25rem;
        letter-spacing: 0.04em;
      }

      .title span {
        font-size: 0.8rem;
        color: #9ca3af;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.18);
        font-size: 0.75rem;
        color: #bfdbfe;
        border: 1px solid rgba(59, 130, 246, 0.5);
      }

      .pill-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .controls label {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .controls select {
        font-size: 0.8rem;
        border-radius: 999px;
        border: 1px solid #374151;
        background: #020617;
        color: #e5e7eb;
        padding: 4px 10px;
        outline: none;
      }

      .summary {
        margin-top: 4px;
        margin-bottom: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #111827;
        font-size: 0.78rem;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .summary-block {
        min-width: 0;
      }

      .summary-label {
        display: block;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.09em;
        color: #6b7280;
        margin-bottom: 2px;
      }

      .summary-value {
        font-size: 0.8rem;
        color: #e5e7eb;
        word-break: break-word;
      }

      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        grid-template-rows: auto auto;
        gap: 10px;
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: radial-gradient(circle at top left, #020617, #020617);
        border-radius: 14px;
        padding: 10px 12px;
        border: 1px solid #111827;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.5);
      }

      .card h3 {
        margin: 0 0 6px;
        font-size: 0.9rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .tag-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .tag {
        border-radius: 999px;
        padding: 3px 8px;
        background: #0b1220;
        border: 1px solid #1f2937;
        font-size: 0.72rem;
        color: #e5e7eb;
        max-width: 100%;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .tag-score {
        opacity: 0.7;
        margin-left: 4px;
      }

      .list {
        list-style: none;
        margin: 0;
        margin-top: 4px;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .list-item-title {
        font-size: 0.8rem;
        font-weight: 500;
        color: #e5e7eb;
      }

      .list-item-body {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .confidence-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 6px;
      }

      .confidence-high {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
        border: 1px solid rgba(34, 197, 94, 0.4);
      }

      .confidence-medium {
        background: rgba(250, 204, 21, 0.2);
        color: #facc15;
        border: 1px solid rgba(250, 204, 21, 0.4);
      }

      .confidence-low {
        background: rgba(156, 163, 175, 0.2);
        color: #9ca3af;
        border: 1px solid rgba(156, 163, 175, 0.4);
      }

      .citation-link {
        color: #60a5fa;
        text-decoration: none;
        font-size: 0.7rem;
        margin-right: 8px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .citation-link:hover {
        text-decoration: underline;
      }

      .citation-count {
        font-size: 0.65rem;
        color: #9ca3af;
        font-weight: 500;
      }

      .citation-impact {
        font-size: 0.8rem;
        margin-left: 2px;
      }

      .oa-indicator {
        font-size: 0.7rem;
        margin-left: 4px;
        color: #22c55e;
        text-decoration: none;
      }

      .oa-indicator:hover {
        color: #16a34a;
      }

      .hidden {
        display: none !important;
      }

      .citations-section {
        margin-top: 8px;
        padding-top: 6px;
        border-top: 1px solid #1f2937;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .data-source-badge {
        display: inline-block;
        padding: 2px 6px;
        margin: 2px;
        border-radius: 3px;
        background: rgba(59, 130, 246, 0.15);
        color: #93c5fd;
        font-size: 0.65rem;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .risk-low {
        color: #4ade80;
      }
      .risk-medium {
        color: #facc15;
      }
      .risk-high {
        color: #f97316;
      }

      .empty-state {
        font-size: 0.8rem;
        color: #9ca3af;
        padding: 10px;
      }

      footer {
        margin-top: 8px;
        font-size: 0.7rem;
        color: #6b7280;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .footer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      footer a {
        color: #93c5fd;
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div class="title">
          <div class="pill">
            <span class="pill-dot"></span>
            GaiaLab Â· Multi-source Integration
          </div>
          <h2>Living Systems Design Canvas</h2>
          <span>Powered by multi-source biological datasets Â· 2.4M+ bioactive compounds Â· Citation-enriched insights</span>
        </div>
        <div class="controls">
          <label for="audience-select">Audience</label>
          <select id="audience-select">
            <option value="researcher">Researcher</option>
            <option value="clinician">Clinician</option>
            <option value="executive">Executive</option>
            <option value="student">Student</option>
          </select>
          <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
            <input type="checkbox" id="oa-toggle" style="cursor: pointer;">
            <span>Open Access Only</span>
          </label>
          <div style="display: flex; gap: 4px; margin-left: 12px;">
            <button id="export-csv-btn" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #374151; background: #020617; color: #e5e7eb; cursor: pointer;">ðŸ“„ CSV</button>
            <button id="export-json-btn" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #374151; background: #020617; color: #e5e7eb; cursor: pointer;">ðŸ’¾ JSON</button>
          </div>
        </div>
      </header>

      <section class="summary" id="summary">
        <!-- Filled by JS -->
      </section>

      <section class="grid">
        <section class="card" id="genes-card">
          <h3>Gene Signals</h3>
          <div class="tag-row" id="genes-tags"></div>
        </section>

        <section class="card" id="topics-card">
          <h3>Literature Themes</h3>
          <ul class="list" id="topics-list"></ul>
        </section>

        <section class="card" id="pathways-card">
          <h3>Pathway Constellations</h3>
          <ul class="list" id="pathways-list"></ul>
        </section>

        <section class="card" id="strategies-card">
          <h3>Conceptual Directions</h3>
          <ul class="list" id="strategies-list"></ul>
        </section>

        <section class="card" id="network3d-card" style="grid-column: 1 / -1; margin-bottom: 16px;">
          <h3>ðŸ§¬ Protein Interaction Network (3D)</h3>
          <div id="network3d-container" style="width: 100%; height: 500px; position: relative; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; margin-bottom: 12px;"></div>
          <div class="empty-state" id="network3d-loading">Loading 3D visualization...</div>
          <div class="empty-state" id="network3d-empty" style="display: none;">No interaction data available for 3D visualization.</div>
          <div id="network3d-info" style="margin-top: 8px; font-size: 0.85rem; color: #9ca3af; display: none;">
            <span id="network3d-stats"></span>
            <div style="margin-top: 4px; font-size: 0.75rem;">
              ðŸ’¡ Tip: Click and drag to rotate â€¢ Scroll to zoom â€¢ Click nodes for details
            </div>
          </div>
        </section>

        <section class="card" id="researchers-card">
          <h3>Leading Researchers</h3>
          <ul class="list" id="researchers-list"></ul>
        </section>

        <section class="card" id="recommendations-card">
          <h3>Related Papers</h3>
          <ul class="list" id="recommendations-list"></ul>
        </section>
      </section>

      <footer id="footer">
        <div class="footer-row">
          <span id="disclaimer"
            >AI-generated insights for research. Requires expert validation.</span
          >
          <span id="timestamp"></span>
        </div>
        <div class="footer-row" id="data-sources">
          <span style="color: #6b7280;">Data sources:</span>
          <div id="source-badges"></div>
        </div>
      </footer>
    </main>

    <!-- 3D Visualization Libraries (FREE - MIT License) -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.0/dist/3d-force-graph.min.js"></script>

    <script type="module">
      const summaryEl = document.querySelector("#summary");
      const genesTagsEl = document.querySelector("#genes-tags");
      const topicsListEl = document.querySelector("#topics-list");
      const pathwaysListEl = document.querySelector("#pathways-list");
      const strategiesListEl = document.querySelector("#strategies-list");
      const researchersListEl = document.querySelector("#researchers-list");
      const recommendationsListEl = document.querySelector("#recommendations-list");
      const audienceSelectEl = document.querySelector("#audience-select");
      const oaToggleEl = document.querySelector("#oa-toggle");
      const timestampEl = document.querySelector("#timestamp");

      let board = window.openai?.toolOutput ?? null;
      let oaFilterEnabled = false;

      const renderSummary = () => {
        summaryEl.innerHTML = "";
        if (!board) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent =
            "No insights yet. Ask ChatGPT to call GaiaLab with a gene list and disease context to generate a board.";
          summaryEl.appendChild(div);
          return;
        }

        const ctxBlock = document.createElement("div");
        ctxBlock.className = "summary-block";
        ctxBlock.innerHTML = `
          <span class="summary-label">Context</span>
          <span class="summary-value">${board.diseaseContext || "â€”"}</span>
        `;

        const geneBlock = document.createElement("div");
        geneBlock.className = "summary-block";
        const topGenes = (board.genes || [])
          .slice(0, 6)
          .map((g) => g.symbol)
          .join(", ");
        geneBlock.innerHTML = `
          <span class="summary-label">Genes</span>
          <span class="summary-value">${
            topGenes || "No genes detected in tool output"
          }</span>
        `;

        const audienceBlock = document.createElement("div");
        audienceBlock.className = "summary-block";
        audienceBlock.innerHTML = `
          <span class="summary-label">View</span>
          <span class="summary-value">${board.audienceLabel || "â€”"}</span>
        `;

        summaryEl.appendChild(ctxBlock);
        summaryEl.appendChild(geneBlock);
        summaryEl.appendChild(audienceBlock);
      };

      const renderTags = () => {
        genesTagsEl.innerHTML = "";
        if (!board || !board.genes || board.genes.length === 0) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent = "Waiting for gene context.";
          genesTagsEl.appendChild(div);
          return;
        }

        board.genes.forEach((gene) => {
          const span = document.createElement("span");
          span.className = "tag";
          const score =
            gene.importanceScore != null
              ? `<span class="tag-score">Â· ${Math.round(
                  gene.importanceScore * 100
                )}% signal</span>`
              : "";
          span.innerHTML = `${gene.symbol}${score}`;
          genesTagsEl.appendChild(span);
        });
      };

      const renderList = (items, container, emptyMessage, options = {}) => {
        container.innerHTML = "";
        if (!items || items.length === 0) {
          const li = document.createElement("li");
          li.className = "empty-state";
          li.textContent = emptyMessage;
          container.appendChild(li);
          return;
        }

        items.forEach((item) => {
          const li = document.createElement("li");
          const titleDiv = document.createElement("div");
          titleDiv.className = "list-item-title";

          if (options.showRisk && item.riskLevel) {
            const badge = document.createElement("span");
            const level = String(item.riskLevel).toLowerCase();
            badge.textContent = level.toUpperCase();
            badge.className = `risk-${level}`;
            titleDiv.appendChild(badge);
            titleDiv.appendChild(document.createTextNode(" Â· "));
          }

          titleDiv.appendChild(document.createTextNode(item.name || item.label || item.theme));

          // Add confidence badge if present
          if (item.confidence) {
            const confBadge = document.createElement("span");
            confBadge.className = `confidence-badge confidence-${item.confidence}`;
            confBadge.textContent = item.confidence;
            titleDiv.appendChild(confBadge);
          }

          const bodyDiv = document.createElement("div");
          bodyDiv.className = "list-item-body";
          bodyDiv.textContent = item.summary || item.rationale || "";

          li.appendChild(titleDiv);
          li.appendChild(bodyDiv);

          // Add citations if present
          if (item.citations && item.citations.length > 0) {
            const citationsDiv = document.createElement("div");
            citationsDiv.className = "citations-section";

            item.citations.forEach((citation) => {
              const pmid = citation.replace("PMID:", "");
              const link = document.createElement("a");
              link.href = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;
              link.target = "_blank";
              link.className = "citation-link";

              // Display PMID
              link.appendChild(document.createTextNode(citation));

              // Add citation count if available
              if (board.citationCounts && board.citationCounts[pmid] !== undefined) {
                const count = board.citationCounts[pmid];
                const countSpan = document.createElement("span");
                countSpan.className = "citation-count";
                countSpan.textContent = `(${count.toLocaleString()})`;
                link.appendChild(countSpan);

                // Add impact indicator for highly cited papers
                if (count >= 500) {
                  const fire = document.createElement("span");
                  fire.className = "citation-impact";
                  fire.textContent = "ðŸ”¥";
                  fire.title = "Seminal paper (500+ citations)";
                  link.appendChild(fire);
                } else if (count >= 100) {
                  const star = document.createElement("span");
                  star.className = "citation-impact";
                  star.textContent = "â­";
                  star.title = "Highly influential (100+ citations)";
                  link.appendChild(star);
                }
              }

              // Add Open Access indicator if available
              const hasOA = board.openAccessMap && board.openAccessMap[pmid];
              if (hasOA) {
                const oaLink = document.createElement("a");
                oaLink.href = board.openAccessMap[pmid];
                oaLink.target = "_blank";
                oaLink.className = "oa-indicator";
                oaLink.textContent = "ðŸ“„ OA";
                oaLink.title = "Open Access PDF available";
                link.appendChild(oaLink);
              }

              // Apply OA filter if enabled
              if (oaFilterEnabled && !hasOA) {
                link.classList.add("hidden");
              }

              citationsDiv.appendChild(link);
            });

            li.appendChild(citationsDiv);
          }

          container.appendChild(li);
        });
      };

      const renderTimestamp = () => {
        if (!board || !board.generatedAtIso) {
          timestampEl.textContent = "";
          return;
        }
        const date = new Date(board.generatedAtIso);
        if (Number.isNaN(date.getTime())) {
          timestampEl.textContent = "";
          return;
        }
        const timeStr = board.analysisTime ? ` (${board.analysisTime})` : "";
        timestampEl.textContent = `Generated ${date.toLocaleString()}${timeStr}`;
      };

      const renderDataSources = () => {
        const sourceBadges = document.querySelector("#source-badges");
        const disclaimerEl = document.querySelector("#disclaimer");

        if (!sourceBadges) return;

        sourceBadges.innerHTML = "";

        // Show multi-source integration
        if (board?.databaseStats) {
          const statsDiv = document.createElement("div");
          statsDiv.style.display = "flex";
          statsDiv.style.flexWrap = "wrap";
          statsDiv.style.gap = "4px";
          statsDiv.style.alignItems = "center";

          // Total databases badge
          const totalBadge = document.createElement("span");
          totalBadge.className = "data-source-badge";
          totalBadge.style.background = "rgba(34, 197, 94, 0.2)";
          totalBadge.style.borderColor = "rgba(34, 197, 94, 0.5)";
          totalBadge.style.color = "#86efac";
          totalBadge.textContent = "Multi-source datasets";
          statsDiv.appendChild(totalBadge);

          // Individual database badges
          board.databaseStats.databases.forEach((db) => {
            const badge = document.createElement("span");
            badge.className = "data-source-badge";
            badge.textContent = db;
            statsDiv.appendChild(badge);
          });

          // Compounds badge
          const compoundsBadge = document.createElement("span");
          compoundsBadge.className = "data-source-badge";
          compoundsBadge.style.background = "rgba(59, 130, 246, 0.2)";
          compoundsBadge.style.borderColor = "rgba(59, 130, 246, 0.5)";
          compoundsBadge.textContent = `${board.databaseStats.bioactiveCompounds} Bioactive Compounds`;
          statsDiv.appendChild(compoundsBadge);

          sourceBadges.appendChild(statsDiv);
        } else if (board?.dataSource) {
          // Fallback to old format if databaseStats not available
          const sources = [
            { name: "Genes", value: board.dataSource.genes },
            { name: "Pathways", value: board.dataSource.pathways },
            { name: "Literature", value: board.dataSource.literature },
            { name: "AI", value: board.dataSource.ai }
          ];

          sources.forEach((source) => {
            const badge = document.createElement("span");
            badge.className = "data-source-badge";
            badge.textContent = `${source.name}: ${source.value}`;
            sourceBadges.appendChild(badge);
          });
        }

        if (disclaimerEl && board?.disclaimer) {
          disclaimerEl.textContent = board.disclaimer;
        }
      };

      const renderResearchers = () => {
        researchersListEl.innerHTML = "";

        if (!board || !board.leadingResearchers || board.leadingResearchers.length === 0) {
          const li = document.createElement("li");
          li.textContent = "Leading researchers will appear when literature data is available.";
          li.style.color = "#6b7280";
          li.style.fontStyle = "italic";
          researchersListEl.appendChild(li);
          return;
        }

        board.leadingResearchers.forEach((researcher) => {
          const li = document.createElement("li");

          const nameDiv = document.createElement("div");
          nameDiv.className = "list-item-title";
          nameDiv.textContent = researcher.name;

          const roleSpan = document.createElement("span");
          roleSpan.style.fontSize = "0.65rem";
          roleSpan.style.color = "#9ca3af";
          roleSpan.style.marginLeft = "8px";
          roleSpan.textContent = researcher.role || "Contributor";
          nameDiv.appendChild(roleSpan);

          const statsDiv = document.createElement("div");
          statsDiv.className = "list-item-body";
          statsDiv.textContent = `${researcher.paperCount} papers Â· ${researcher.totalCitations.toLocaleString()} citations Â· ${researcher.avgCitations} avg`;

          if (researcher.topPaper) {
            const topPaperDiv = document.createElement("div");
            topPaperDiv.style.fontSize = "0.65rem";
            topPaperDiv.style.color = "#6b7280";
            topPaperDiv.style.marginTop = "4px";
            topPaperDiv.innerHTML = `<strong>Top paper:</strong> ${researcher.topPaper.title?.substring(0, 80) || 'Unknown'}... (${researcher.topPaper.citationCount} citations)`;
            statsDiv.appendChild(topPaperDiv);
          }

          li.appendChild(nameDiv);
          li.appendChild(statsDiv);
          researchersListEl.appendChild(li);
        });
      };

      const renderRecommendations = () => {
        recommendationsListEl.innerHTML = "";

        if (!board || !board.recommendedPapers || board.recommendedPapers.length === 0) {
          const li = document.createElement("li");
          li.textContent = "Related paper recommendations will appear when available.";
          li.style.color = "#6b7280";
          li.style.fontStyle = "italic";
          recommendationsListEl.appendChild(li);
          return;
        }

        board.recommendedPapers.forEach((paper) => {
          const li = document.createElement("li");

          const titleDiv = document.createElement("div");
          titleDiv.className = "list-item-title";
          titleDiv.textContent = paper.title;

          const metaDiv = document.createElement("div");
          metaDiv.className = "list-item-body";
          metaDiv.innerHTML = `${paper.authors} Â· ${paper.year} Â· ${paper.citationCount.toLocaleString()} citations`;

          // Add OA link if available
          if (paper.openAccessUrl) {
            const oaLink = document.createElement("a");
            oaLink.href = paper.openAccessUrl;
            oaLink.target = "_blank";
            oaLink.className = "oa-indicator";
            oaLink.textContent = "ðŸ“„ Download PDF";
            oaLink.style.marginLeft = "8px";
            metaDiv.appendChild(oaLink);
          }

          // Add PubMed link
          if (paper.pmid) {
            const pmidLink = document.createElement("a");
            pmidLink.href = `https://pubmed.ncbi.nlm.nih.gov/${paper.pmid}/`;
            pmidLink.target = "_blank";
            pmidLink.className = "citation-link";
            pmidLink.textContent = `PMID:${paper.pmid}`;
            pmidLink.style.display = "inline-block";
            pmidLink.style.marginTop = "4px";
            metaDiv.appendChild(pmidLink);
          }

          li.appendChild(titleDiv);
          li.appendChild(metaDiv);
          recommendationsListEl.appendChild(li);
        });
      };

      // 3D Network Visualization (THREE.js + 3d-force-graph) - FREE!
      let graph3d = null;
      const render3DNetwork = () => {
        const container = document.querySelector("#network3d-container");
        const loadingEl = document.querySelector("#network3d-loading");
        const emptyEl = document.querySelector("#network3d-empty");
        const infoEl = document.querySelector("#network3d-info");
        const statsEl = document.querySelector("#network3d-stats");

        // Reset visibility
        loadingEl.style.display = "none";
        emptyEl.style.display = "none";
        infoEl.style.display = "none";
        container.style.display = "none";

        if (!board || !board.network3DData || !board.network3DData.nodes || board.network3DData.nodes.length === 0) {
          emptyEl.style.display = "block";
          return;
        }

        const networkData = board.network3DData;

        // Show container and info
        container.style.display = "block";
        infoEl.style.display = "block";
        statsEl.textContent = `${networkData.stats.totalNodes} proteins â€¢ ${networkData.stats.totalLinks} interactions â€¢ ${(networkData.stats.avgConfidence * 100).toFixed(0)}% avg confidence`;

        // Create or update 3D graph
        if (!graph3d) {
          // Initialize 3D force graph (runs entirely in browser - $0 cost!)
          graph3d = ForceGraph3D()(container)
            .graphData(networkData)
            .nodeLabel(node => `${node.name}\nImportance: ${(node.importance * 100).toFixed(0)}%${node.isHub ? '\nðŸ”¥ Network Hub' : ''}`)
            .nodeColor(node => node.isHub ? '#ff6b6b' : `hsl(${200 + node.importance * 80}, 70%, 50%)`)
            .nodeVal(node => node.val)
            .linkWidth(link => link.value * 2)
            .linkColor(() => 'rgba(255,255,255,0.2)')
            .linkDirectionalParticles(2)
            .linkDirectionalParticleWidth(link => link.value * 2)
            .backgroundColor('#00000000')
            .onNodeClick(node => {
              alert(`Gene: ${node.id}\nName: ${node.name}\nImportance: ${(node.importance * 100).toFixed(0)}%${node.isHub ? '\nNetwork Hub (High Centrality)' : ''}`);
            });

          // Add camera animation
          const distance = 250;
          const distRatio = 1 + distance/Math.hypot(networkData.nodes[0].x, networkData.nodes[0].y, networkData.nodes[0].z);
          graph3d.cameraPosition(
            { x: networkData.nodes[0].x * distRatio, y: networkData.nodes[0].y * distRatio, z: networkData.nodes[0].z * distRatio },
            networkData.nodes[0],
            3000
          );
        } else {
          // Update existing graph
          graph3d.graphData(networkData);
        }

        loadingEl.style.display = "none";
      };

      const renderAll = () => {
        // Keep select in sync
        if (board && board.audience && audienceSelectEl) {
          audienceSelectEl.value = board.audience;
        }

        renderSummary();
        renderTags();
        renderList(
          board?.topics,
          topicsListEl,
          "Themes will appear here once GaiaLab has seen some context."
        );
        renderList(
          board?.pathways,
          pathwaysListEl,
          "Pathway-level patterns will populate here.",
          { showRisk: false }
        );
        renderList(
          board?.strategies,
          strategiesListEl,
          "High-level, non-procedural directions will show here.",
          { showRisk: true }
        );
        renderResearchers();
        renderRecommendations();
        render3DNetwork(); // NEW: Render 3D protein interaction network
        renderTimestamp();
        renderDataSources();
      };

      const updateFromResponse = (response) => {
        if (response?.structuredContent) {
          board = response.structuredContent;
          renderAll();
        }
      };

      const handleSetGlobals = (event) => {
        const globals = event.detail?.globals;
        if (!globals?.toolOutput) return;
        board = globals.toolOutput;
        renderAll();
      };

      window.addEventListener("openai:set_globals", handleSetGlobals, {
        passive: true
      });

      if (audienceSelectEl) {
        audienceSelectEl.addEventListener("change", async (event) => {
          const nextAudience = event.target.value;
          if (!board) {
            return;
          }

          if (window.openai?.callTool) {
            const payload = {
              genes: (board.genes || []).map((g) => g.symbol),
              diseaseContext: board.diseaseContext,
              audience: nextAudience
            };

            try {
              const response = await window.openai.callTool(
                "gaialab_generate_insights",
                payload
              );
              updateFromResponse(response);
            } catch (err) {
              console.error("Tool call failed", err);
            }
          } else {
            // Fallback for local/manual testing
            board.audience = nextAudience;
            renderAll();
          }
        });
      }

      // OA toggle filter
      if (oaToggleEl) {
        oaToggleEl.addEventListener("change", (event) => {
          oaFilterEnabled = event.target.checked;
          renderAll(); // Re-render to apply filter
        });
      }

      // Export functions
      const exportToCSV = () => {
        if (!board) return alert("No data to export");

        let csv = "GaiaLab Analysis Export\\n\\n";
        csv += `Disease Context:,${board.diseaseContext}\\n`;
        csv += `Generated:,${board.generatedAtIso}\\n`;
        csv += `Analysis Time:,${board.analysisTime}\\n`;
        csv += `Databases:,multi-source integrated datasets\\n\\n`;

        // Genes section
        csv += "GENES\\n";
        csv += "Symbol,Name,Function,Importance Score,UniProt ID\\n";
        (board.genes || []).forEach(g => {
          csv += `${g.symbol},"${g.name || ''}","${(g.function || '').replace(/"/g, '""')}",${g.importanceScore || ''},${g.uniprotId || ''}\\n`;
        });

        // Pathways section
        csv += "\\nPATHWAYS\\n";
        csv += "Name,P-value,Confidence,Citations\\n";
        (board.pathways || []).forEach(p => {
          csv += `"${p.name}",${p.pvalue || ''},${p.confidence || ''},"${(p.citations || []).join('; ')}"\\n`;
        });

        // Literature themes
        csv += "\\nLITERATURE THEMES\\n";
        csv += "Theme,Summary,Citations\\n";
        (board.topics || []).forEach(t => {
          csv += `"${t.theme || ''}","${(t.summary || '').replace(/"/g, '""')}","${(t.citations || []).join('; ')}"\\n`;
        });

        // Therapeutic strategies
        csv += "\\nTHERAPEUTIC STRATEGIES\\n";
        csv += "Strategy,Rationale,Risk Level,Citations\\n";
        (board.strategies || []).forEach(s => {
          csv += `"${s.label || ''}","${(s.rationale || '').replace(/"/g, '""')}",${s.riskLevel || ''},"${(s.citations || []).join('; ')}"\\n`;
        });

        // Leading researchers
        if (board.leadingResearchers && board.leadingResearchers.length > 0) {
          csv += "\\nLEADING RESEARCHERS\\n";
          csv += "Name,Role,Paper Count,Total Citations,Avg Citations\\n";
          board.leadingResearchers.forEach(r => {
            csv += `"${r.name}",${r.role},${r.paperCount},${r.totalCitations},${r.avgCitations}\\n`;
          });
        }

        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `gaialab-analysis-${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
      };

      const exportToJSON = () => {
        if (!board) return alert("No data to export");

        const exportData = {
          ...board,
          exportedAt: new Date().toISOString(),
          version: "1.0"
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `gaialab-analysis-${new Date().toISOString().slice(0,10)}.json`;
        link.click();
      };

      // Export button event listeners
      const csvBtn = document.querySelector("#export-csv-btn");
      const jsonBtn = document.querySelector("#export-json-btn");

      if (csvBtn) {
        csvBtn.addEventListener("click", exportToCSV);
      }

      if (jsonBtn) {
        jsonBtn.addEventListener("click", exportToJSON);
      }

      renderAll();
    </script>
  </body>
</html>
